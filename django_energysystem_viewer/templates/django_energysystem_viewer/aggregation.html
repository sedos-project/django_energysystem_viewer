{% extends "django_energysystem_viewer/base.html" %}

{% load static %}

{% block content %}
  {{ block.super }}
  <div class="container">
    <h1>Aggregation Graph</h1>
    <form id="aggregation_form">
      <label for="sectors">Choose Sector:</label>
      <select id="sectors" name="sectors" multiple>
        <option label="Power" value="pow"></option>
        <option label="X2X" value="x2x"></option>
        <option label="Industry" value="ind"></option>
        <option label="Transport" value="tra"></option>
        <option label="Heat" value="hea"></option>
      </select>
      <label for="lod">Choose the desired level of detail with the slider:</label>
      <input type="text"
             class="js-range-slider"
             name="lod"
             value=""
             data-values="['sectors', 'first level of detail', 'second level of detail', 'third level of detail']"
             data-grid="true" />
    </form>
    {# djlint:off H021 #}
    <div id="aggregation_graph" style="width: auto; height: 800px"></div>
    {# djlint:on #}
  </div>
{% endblock content %}

{% block javascript %}
  <script src="{% static 'vendors/cytoscape/js/cytoscape.min.js' %}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize cytoscape graph
        const cy = cytoscape(
            {
                container: document.getElementById('aggregation_graph'),
                elements: []
            }
        );

        const aggregation_form = document.getElementById("aggregation_form");
        aggregation_form.addEventListener("change", updateAggregationGraph);

        function updateAggregationGraph() {
            console.log("Get aggregation data")
            const formData = new FormData(aggregation_form);
            const url = "/energysystem/aggregation_graph";

            // Append form data to URL
            const queryString = new URLSearchParams(formData).toString();
            var requestUrl = url + "?" + queryString;

            fetch(requestUrl)
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    cy.json({ elements: data["elements"] });
                    cy.resize();
                })
                .catch(error => {
                    console.error('Error requesting aggregation data:', error);
                });
        }
    });
  </script>
{% endblock javascript %}
